% We begin our Great Adventure !

/* build_error_message(+Type, +Var, -Message)
 * Constructs an error message of the given @Type
 * With the possible help of the information @Var
 * And put it inside the @Message
 */
build_error_message(Type, Var, Message) :-
    % The table does not exist
    Type = no_table, !,
    string_concat("Table ", Var, Temp),
    string_concat(Temp, " does not exist", Message);
    
    % The table already exist
    Type = already_exists, !,
    string_concat("Table ", Var, Temp),
    string_concat(Temp, " already exists in database", Message);
    
    % Bad row insertion
    Type = missing_columns, !,
    (Found, Existing) = Var,
    string_concat("Row conflict. You tried to insert ", Found, Temp),
    string_concat(Temp, " while the table has ", Temp2),
    string_concat(Temp2, Existing, Temp3),
    string_concat(Temp3, " row(s)", Message);
    
    % The exception is unknown
    throw("Incexception : unexpected exception").

/* print_elems(+List)
 * Prints the elements of the @List,
 * one element per line
 *
 */ 
print_elems([]).
print_elems([Head|Tail]) :- 
    writeln(Head), 
    print_elems(Tail).
    
assert_table_exists(Table) :-
    tables(Tables),
    member(Table, Tables).

tables :- 
    findall(X, table(X,_,_), Tables), % find all tables
    print_elems(Tables).               % display them

tables(Tables) :- 
    findall(X, table(X,_,_), Tables).

create(Table, Cols) :- 
    % Todo : check if two cols do not have the same name
    % Todo : check that Cols is not empty
    tables(Tables),
    ( 
    member(Table, Tables) 
        -> 
        !, 
        build_error_message(already_exists, Table, Message),
        throw(Message)
        ;
        length(Cols, Length),               
        assert(table(Table, Cols, Length))
    ).

cols(Table, Cols) :-
    tables(Tables),
    ( 
    member(Table, Tables) 
        -> 
        table(Table, Cols, _)
        ;
        !,
        build_error_message(no_table, Table, Message),
        throw(Message)
    ).

rows(Table) :-
    % Todo : error message if table empty    
    tables(Tables),
    ( 
    member(Table, Tables) 
        -> 
        findall(X, row(Table, X), Rows),
        print_elems(Rows)
        ;
        !, 
        build_error_message(no_table, Table, Message),
        throw(Message)
    ).

insert(Table, Row) :-
    % If table exists
    assert_table_exists(Table), !,
    table(Table, _, Length),
    (Length = length(Row)
        ->
            writeln("Coucou")
        ;
        build_error_message(
            missing_columns, 
            (Length, length(Row)), 
            Message)
        
    )
    ;
    
    % Else
    writeln("FAIL").

drop(Table) :-
    member(Table, Tables),
    (
        ->
        retractall(row(Table,_)),
        retract(table(Table,_,_))
        ;
        build_error_message(no_table,Table,Message),
        !,throw(Message)
    ).

delete(Table).

delete(Table,Conds).

selec(TableOrTables, Selectors, Conds, Projection).
